<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iberian Gauge P2P</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.1/peerjs.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        #lobby {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: rgba(0,0,0,0.3);
        }
        
        .lobby-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }
        
        .lobby-title {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        #game {
            display: none;
            height: 100vh;
            position: relative;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        #gameCanvas:active {
            cursor: grabbing;
        }
        
        .hud {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        #gameInfo {
            top: 20px;
            left: 20px;
            min-width: 250px;
        }
        
        #playerList {
            top: 20px;
            right: 20px;
            min-width: 200px;
        }
        
        #controls {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        #sharePanel {
            bottom: 20px;
            left: 20px;
            max-width: 300px;
        }
        
        .railroad-shares {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .railroad-btn {
            padding: 10px;
            border-radius: 5px;
            border: 2px solid transparent;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .railroad-btn:hover {
            transform: scale(1.05);
            border-color: white;
        }
        
        .railroad-purple { background: #8B008B; color: white; }
        .railroad-orange { background: #FF8C00; color: white; }
        .railroad-blue { background: #4169E1; color: white; }
        .railroad-yellow { background: #FFD700; color: black; }
        .railroad-red { background: #DC143C; color: white; }
        
        .player-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .current-player {
            background: rgba(102, 126, 234, 0.3);
            border: 2px solid #667eea;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .hex {
            transition: fill 0.3s;
        }
        
        .hex:hover {
            filter: brightness(1.2);
        }
        
        .locomotive {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="lobby">
        <div class="lobby-card">
            <h1 class="lobby-title">Iberian Gauge</h1>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="playerName" placeholder="Enter your name" value="Player">
            </div>
            <div class="input-group">
                <label>Room ID (leave empty to create new room)</label>
                <input type="text" id="roomId" placeholder="Enter room ID to join">
            </div>
            <button class="btn" id="startBtn">Start / Join Game</button>
            <div id="connectionStatus" style="margin-top: 20px; text-align: center; color: #666;"></div>
        </div>
    </div>
    
    <div id="game">
        <canvas id="gameCanvas"></canvas>
        
        <div id="gameInfo" class="hud">
            <h3 style="margin-top: 0;">Game Info</h3>
            <div id="roundInfo">Round: Stock 1</div>
            <div id="priorityInfo">Priority Deal: None</div>
            <button class="btn" id="nextRoundBtn" style="margin-top: 10px;">Next Round</button>
        </div>
        
        <div id="playerList" class="hud">
            <h3 style="margin-top: 0;">Players</h3>
            <div id="players"></div>
        </div>
        
        <div id="actionLog" class="hud" style="top: 200px; right: 20px; max-height: 300px; overflow-y: auto;">
            <h3 style="margin-top: 0;">Action Log</h3>
            <div id="actions"></div>
        </div>
        
        <div id="sharePanel" class="hud">
            <h3 style="margin-top: 0;">Railroad Shares</h3>
            <div class="railroad-shares" id="railroadButtons"></div>
            <div id="shareInfo" style="margin-top: 10px;"></div>
            <div style="margin-top: 10px; font-size: 11px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px;">
                <strong>Terrain Costs:</strong><br>
                üü¢ Easy: ‚Çß4 | üü´ Difficult: ‚Çß8<br>
                üèòÔ∏è City: ‚Çß4 | üèõÔ∏è Major City: ‚Çß4<br>
                <small>Cities give +1 Div, Major +2 Div & +‚Çß2 Share Value</small><br>
                <strong style="margin-top: 5px; display: block;">Controls:</strong>
                <small>WASD/Arrows: Pan | +/-: Zoom | R: Reset View</small>
            </div>
        </div>
        
        <div id="controls" class="hud">
            <button class="btn" id="claimPriorityBtn" style="width: auto;">Claim Priority Deal</button>
            <button class="btn" id="payDividendsBtn" style="width: auto;">Pay Dividends</button>
            <button class="btn" id="resetBtn" style="width: auto;">Reset Game</button>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            players: [],
            round: 'stock',
            roundNumber: 1,
            railroads: {
                purple: { shares: [], treasury: 0, shareValue: 20, dividends: 0, locomotives: [] },
                orange: { shares: [], treasury: 0, shareValue: 20, dividends: 0, locomotives: [] },
                blue: { shares: [], treasury: 0, shareValue: 20, dividends: 0, locomotives: [] },
                yellow: { shares: [], treasury: 0, shareValue: 20, dividends: 0, locomotives: [] },
                red: { shares: [], treasury: 0, shareValue: 20, dividends: 0, locomotives: [] }
            },
            hexMap: [],
            myPlayerId: null,
            actionLog: [],
            priorityDealHolder: null,
            // Dividend track values from the actual board
            dividendTrack: [
                { purple: 0, orange: 0, blue: 0, yellow: 0, red: 0 },
                { purple: 0, orange: 0, blue: 0, yellow: 0, red: 0 },
                { purple: 0, orange: 0, blue: 0, yellow: 0, red: 0 },
                { purple: 0, orange: 2, blue: 2, yellow: 0, red: 0 },
                { purple: 2, orange: 2, blue: 2, yellow: 2, red: 0 },
                { purple: 2, orange: 4, blue: 4, yellow: 2, red: 2 },
                { purple: 4, orange: 4, blue: 4, yellow: 4, red: 2 },
                { purple: 4, orange: 6, blue: 6, yellow: 4, red: 4 },
                { purple: 6, orange: 6, blue: 6, yellow: 6, red: 4 },
                { purple: 6, orange: 8, blue: 8, yellow: 6, red: 6 },
                { purple: 8, orange: 8, blue: 8, yellow: 8, red: 6 },
                { purple: 8, orange: 10, blue: 10, yellow: 8, red: 8 },
                { purple: 10, orange: 10, blue: 10, yellow: 10, red: 8 },
                { purple: 10, orange: 12, blue: 12, yellow: 10, red: 10 },
                { purple: 12, orange: 12, blue: 12, yellow: 12, red: 10 },
                { purple: 12, orange: 14, blue: 14, yellow: 12, red: 12 },
                { purple: 14, orange: 14, blue: 14, yellow: 14, red: 12 },
                { purple: 14, orange: 16, blue: 16, yellow: 14, red: 14 },
                { purple: 16, orange: 16, blue: 16, yellow: 16, red: 14 },
                { purple: 16, orange: 18, blue: 18, yellow: 16, red: 16 },
                { purple: 18, orange: 18, blue: 18, yellow: 18, red: 16 }
            ]
        };
        
        // P2P Connection
        let peer = null;
        let connections = [];
        let isHost = false;
        
        // Canvas Setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let camera = { x: 0, y: 0, zoom: 1 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        
        // Initialize
        document.getElementById('startBtn').addEventListener('click', startGame);
        
        function startGame() {
            const playerName = document.getElementById('playerName').value || 'Player';
            const roomId = document.getElementById('roomId').value;
            
            if (roomId) {
                joinRoom(roomId, playerName);
            } else {
                createRoom(playerName);
            }
        }
        
        function createRoom(playerName) {
            isHost = true;
            const peerId = 'iberian-' + Math.random().toString(36).substr(2, 9);
            
            peer = new Peer(peerId);
            
            peer.on('open', (id) => {
                document.getElementById('connectionStatus').innerHTML = 
                    `<strong>Room Created!</strong><br>Room ID: <code>${id}</code><br>Share this ID with other players`;
                
                gameState.myPlayerId = id;
                gameState.players.push({
                    id: id,
                    name: playerName,
                    money: 40,
                    shares: [],
                    connected: true
                });
                
                setTimeout(() => {
                    document.getElementById('lobby').style.display = 'none';
                    document.getElementById('game').style.display = 'block';
                    initGame();
                }, 2000);
            });
            
            peer.on('connection', (conn) => {
                connections.push(conn);
                setupConnection(conn);
            });
        }
        
        function joinRoom(hostId, playerName) {
            const peerId = 'iberian-' + Math.random().toString(36).substr(2, 9);
            peer = new Peer(peerId);
            
            peer.on('open', (id) => {
                gameState.myPlayerId = id;
                const conn = peer.connect(hostId);
                
                conn.on('open', () => {
                    connections.push(conn);
                    conn.send({
                        type: 'join',
                        playerId: id,
                        playerName: playerName
                    });
                    
                    document.getElementById('lobby').style.display = 'none';
                    document.getElementById('game').style.display = 'block';
                    initGame();
                });
                
                setupConnection(conn);
            });
        }
        
        function setupConnection(conn) {
            conn.on('data', (data) => {
                handleMessage(data, conn);
            });
            
            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
            });
        }
        
        function handleMessage(data, conn) {
            switch(data.type) {
                case 'join':
                    if (isHost) {
                        gameState.players.push({
                            id: data.playerId,
                            name: data.playerName,
                            money: 40,
                            shares: [],
                            connected: true
                        });
                        broadcastGameState();
                        logAction(`${data.playerName} joined the game`);
                    }
                    break;
                case 'gameState':
                    gameState.players = data.players;
                    gameState.round = data.round;
                    gameState.roundNumber = data.roundNumber;
                    gameState.railroads = data.railroads;
                    gameState.actionLog = data.actionLog || [];
                    gameState.priorityDealHolder = data.priorityDealHolder;
                    if (data.hexMap) {
                        gameState.hexMap = data.hexMap;
                    }
                    updateUI();
                    break;
                case 'buyShare':
                    if (isHost) {
                        processBuyShare(data.playerId, data.railroad, data.shareValue);
                        broadcastGameState();
                    }
                    break;
                case 'buildTrack':
                    if (isHost) {
                        processBuildTrack(data.playerId, data.railroad, data.hex);
                        broadcastGameState();
                    }
                    break;
                case 'claimPriority':
                    if (isHost) {
                        processClaimPriority(data.playerId);
                        broadcastGameState();
                    }
                    break;
                case 'nextRound':
                    if (isHost) {
                        processNextRound();
                        broadcastGameState();
                    }
                    break;
                case 'payDividends':
                    if (isHost) {
                        processPayDividends(data.railroad);
                        broadcastGameState();
                    }
                    break;
                case 'action':
                    logAction(data.message);
                    if (isHost) {
                        broadcastGameState();
                    }
                    break;
            }
        }
        
        function broadcastGameState() {
            const message = {
                type: 'gameState',
                players: gameState.players,
                round: gameState.round,
                roundNumber: gameState.roundNumber,
                railroads: gameState.railroads,
                actionLog: gameState.actionLog,
                priorityDealHolder: gameState.priorityDealHolder,
                hexMap: gameState.hexMap
            };
            
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(message);
                }
            });
            updateUI();
        }
        
        function logAction(message) {
            const timestamp = new Date().toLocaleTimeString();
            gameState.actionLog.push({ time: timestamp, message });
            // Keep only last 50 actions
            if (gameState.actionLog.length > 50) {
                gameState.actionLog.shift();
            }
            updateUI();
        }
        
        function initGame() {
            setupCanvas();
            generateHexMap();
            setupEventListeners();
            updateUI();
            
            if (isHost) {
                startStockRound();
            }
        }
        
        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Center the map initially
            camera.x = 50;
            camera.y = 50;
            camera.zoom = 0.8;
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                render();
            });
        }
        
        function generateHexMap() {
            const hexSize = 30;
            
            // Define the Iberian Peninsula map layout
            // Format: [row, col, terrain, cityName (if city)]
            const mapData = [
                // Portugal coast and cities
                [2, 2, 'easy', 'Porto'],
                [3, 2, 'easy'],
                [4, 2, 'easy', 'Coimbra'],
                [5, 2, 'easy'],
                [6, 2, 'easy', 'Lisboa'],
                [7, 2, 'easy'],
                [8, 2, 'easy', 'Faro'],
                
                // Northern Spain
                [1, 5, 'easy', 'Gij√≥n'],
                [1, 7, 'difficult'],
                [1, 9, 'easy', 'Santander'],
                [1, 11, 'easy', 'Bilbao'],
                [1, 13, 'difficult'],
                [1, 15, 'easy', 'Pamplona'],
                
                // Galicia
                [2, 3, 'easy', 'A Coru√±a'],
                [3, 3, 'easy', 'Santiago'],
                [3, 4, 'difficult', 'Ourense'],
                
                // Central Portugal/Spain border
                [4, 3, 'difficult'],
                [4, 4, 'difficult'],
                [5, 3, 'difficult'],
                [5, 4, 'difficult', 'Salamanca'],
                [5, 5, 'easy'],
                
                // Madrid region
                [4, 6, 'difficult'],
                [5, 6, 'difficult', 'Valladolid'],
                [6, 6, 'difficult'],
                [6, 7, 'easy', 'Madrid'],
                [7, 7, 'easy'],
                [7, 6, 'easy', 'Toledo'],
                
                // Eastern Spain
                [2, 13, 'difficult', 'Zaragoza'],
                [3, 14, 'difficult'],
                [3, 15, 'easy', 'Lleida'],
                [2, 16, 'easy', 'Barcelona'],
                [4, 15, 'easy', 'Tarragona'],
                [5, 14, 'easy'],
                [6, 14, 'easy', 'Valencia'],
                [7, 13, 'easy', 'Alicante'],
                
                // Southern Spain
                [8, 4, 'easy', 'Badajoz'],
                [8, 5, 'difficult'],
                [8, 6, 'easy', 'Ciudad Real'],
                [9, 5, 'easy', 'C√≥rdoba'],
                [9, 6, 'easy'],
                [10, 5, 'easy', 'Sevilla'],
                [10, 6, 'easy', 'Granada'],
                [10, 7, 'easy', 'M√°laga'],
                [10, 8, 'easy', 'Almer√≠a'],
                [11, 5, 'easy', 'C√°diz'],
                
                // Fill in remaining terrain
                [3, 5, 'difficult'],
                [3, 6, 'difficult'],
                [3, 7, 'difficult'],
                [3, 8, 'difficult'],
                [3, 9, 'difficult'],
                [3, 10, 'difficult'],
                [3, 11, 'difficult'],
                [3, 12, 'difficult'],
                [4, 5, 'difficult'],
                [4, 7, 'difficult'],
                [4, 8, 'difficult'],
                [4, 9, 'difficult', 'Soria'],
                [4, 10, 'difficult'],
                [4, 11, 'difficult'],
                [4, 12, 'difficult'],
                [4, 13, 'difficult'],
                [4, 14, 'difficult'],
                [5, 7, 'difficult'],
                [5, 8, 'difficult', 'Guadalajara'],
                [5, 9, 'difficult'],
                [5, 10, 'difficult', 'Cuenca'],
                [5, 11, 'difficult'],
                [5, 12, 'difficult', 'Teruel'],
                [5, 13, 'difficult'],
                [6, 8, 'easy'],
                [6, 9, 'easy'],
                [6, 10, 'easy'],
                [6, 11, 'easy'],
                [6, 12, 'easy', 'Castell√≥n'],
                [6, 13, 'easy'],
                [7, 8, 'easy'],
                [7, 9, 'easy', 'Albacete'],
                [7, 10, 'easy'],
                [7, 11, 'easy'],
                [7, 12, 'easy'],
                [8, 7, 'easy'],
                [8, 8, 'easy'],
                [8, 9, 'easy', 'Murcia'],
                [8, 10, 'easy'],
                [9, 7, 'easy', 'Ja√©n'],
                [9, 8, 'easy'],
                [9, 9, 'easy']
            ];
            
            // Major cities (with urban bonus)
            const majorCities = ['Madrid', 'Barcelona', 'Valencia', 'Sevilla', 'Lisboa', 
                                 'Porto', 'Bilbao', 'Zaragoza', 'M√°laga', 'C√°diz'];
            
            gameState.hexMap = [];
            
            mapData.forEach(([row, col, terrain, cityName]) => {
                const x = col * hexSize * 1.5;
                const y = row * hexSize * Math.sqrt(3) + (col % 2 ? hexSize * Math.sqrt(3) / 2 : 0);
                
                gameState.hexMap.push({
                    x, y,
                    row, col,
                    terrain: terrain,
                    isCity: !!cityName,
                    isMajorCity: majorCities.includes(cityName),
                    cityName: cityName || null,
                    locomotives: []
                });
            });
        }
        
        function setupEventListeners() {
            // Canvas dragging
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStart.x = e.clientX - camera.x;
                dragStart.y = e.clientY - camera.y;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    camera.x = e.clientX - dragStart.x;
                    camera.y = e.clientY - dragStart.y;
                    render();
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            // Mouse wheel zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomSpeed = 0.1;
                const oldZoom = camera.zoom;
                if (e.deltaY < 0) {
                    camera.zoom = Math.min(2, camera.zoom + zoomSpeed);
                } else {
                    camera.zoom = Math.max(0.5, camera.zoom - zoomSpeed);
                }
                
                // Zoom towards mouse position
                const zoomRatio = camera.zoom / oldZoom;
                camera.x = e.clientX - (e.clientX - camera.x) * zoomRatio;
                camera.y = e.clientY - (e.clientY - camera.y) * zoomRatio;
                
                render();
            });
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                const moveSpeed = 30;
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                        camera.y += moveSpeed;
                        render();
                        break;
                    case 'ArrowDown':
                    case 's':
                        camera.y -= moveSpeed;
                        render();
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        camera.x += moveSpeed;
                        render();
                        break;
                    case 'ArrowRight':
                    case 'd':
                        camera.x -= moveSpeed;
                        render();
                        break;
                    case '+':
                    case '=':
                        camera.zoom = Math.min(2, camera.zoom + 0.1);
                        render();
                        break;
                    case '-':
                    case '_':
                        camera.zoom = Math.max(0.5, camera.zoom - 0.1);
                        render();
                        break;
                    case 'r':
                        // Reset view
                        camera.x = 50;
                        camera.y = 50;
                        camera.zoom = 0.8;
                        render();
                        break;
                }
            });
            
            // Click on hex
            canvas.addEventListener('click', (e) => {
                if (gameState.round === 'build') {
                    const hex = getHexAtPoint(e.clientX, e.clientY);
                    if (hex) {
                        handleHexClick(hex);
                    }
                }
            });
            
            // Railroad buttons
            const colors = ['purple', 'orange', 'blue', 'yellow', 'red'];
            const buttonsContainer = document.getElementById('railroadButtons');
            
            colors.forEach(color => {
                const btn = document.createElement('div');
                btn.className = `railroad-btn railroad-${color}`;
                btn.textContent = color[0].toUpperCase();
                btn.onclick = () => buyShare(color);
                buttonsContainer.appendChild(btn);
            });
            
            // Control buttons
            document.getElementById('passBtn').onclick = pass;
            document.getElementById('buildBtn').onclick = () => {
                if (gameState.round === 'stock') {
                    gameState.round = 'build';
                    updateUI();
                }
            };
        }
        
        function getHexAtPoint(x, y) {
            const hexSize = 30 * camera.zoom;
            x = (x - camera.x) / camera.zoom;
            y = (y - camera.y) / camera.zoom;
            
            for (const hex of gameState.hexMap) {
                const dx = x - hex.x - hexSize;
                const dy = y - hex.y - hexSize;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < hexSize) {
                    return hex;
                }
            }
            return null;
        }
        
        function buyShare(railroad) {
            const myPlayer = gameState.players.find(p => p.id === gameState.myPlayerId);
            
            // Check if this is the first share
            const isFirstShare = gameState.railroads[railroad].shares.length === 0;
            let shareValue = gameState.railroads[railroad].shareValue;
            
            if (isFirstShare) {
                // For first share, player can choose value between 12-36
                const value = prompt(`Starting ${railroad} railroad. Choose share value (‚Çß12-‚Çß36):`, '20');
                shareValue = Math.max(12, Math.min(36, parseInt(value) || 20));
                gameState.railroads[railroad].shareValue = shareValue;
            }
            
            if (myPlayer && myPlayer.money >= shareValue) {
                const message = {
                    type: 'buyShare',
                    playerId: gameState.myPlayerId,
                    railroad: railroad,
                    shareValue: shareValue
                };
                
                if (isHost) {
                    processBuyShare(gameState.myPlayerId, railroad, shareValue);
                    broadcastGameState();
                } else {
                    connections[0].send(message);
                }
            } else {
                alert(`Insufficient funds. Need ‚Çß${shareValue}, have ‚Çß${myPlayer ? myPlayer.money : 0}`);
            }
        }
        
        function processBuyShare(playerId, railroad, shareValue) {
            const player = gameState.players.find(p => p.id === playerId);
            if (player && player.money >= shareValue) {
                player.money -= shareValue;
                player.shares.push({ railroad, value: shareValue });
                
                gameState.railroads[railroad].shares.push(playerId);
                gameState.railroads[railroad].treasury += shareValue;
                gameState.railroads[railroad].shareValue = shareValue;
                
                const isFirstShare = gameState.railroads[railroad].shares.length === 1;
                if (isFirstShare) {
                    logAction(`${player.name} started ${railroad} railroad at ‚Çß${shareValue} per share`);
                } else {
                    logAction(`${player.name} bought ${railroad} share for ‚Çß${shareValue}`);
                }
            }
        }
        
        function buildTrack(railroad, hex) {
            const cost = hex.terrain === 'difficult' ? 8 : 4;
            
            if (gameState.railroads[railroad].treasury >= cost) {
                const message = {
                    type: 'buildTrack',
                    playerId: gameState.myPlayerId,
                    railroad: railroad,
                    hex: { row: hex.row, col: hex.col }
                };
                
                if (isHost) {
                    processBuildTrack(gameState.myPlayerId, railroad, { row: hex.row, col: hex.col });
                    broadcastGameState();
                } else {
                    connections[0].send(message);
                }
            }
        }
        
        function processBuildTrack(playerId, railroad, hexData) {
            const hex = gameState.hexMap.find(h => h.row === hexData.row && h.col === hexData.col);
            const cost = hex.terrain === 'difficult' ? 8 : 4;
            const player = gameState.players.find(p => p.id === playerId);
            
            if (hex && gameState.railroads[railroad].treasury >= cost) {
                // Check if railroad already has track here
                if (hex.locomotives.includes(railroad)) {
                    logAction(`${railroad} already has track at ${hex.cityName || 'this hex'}`);
                    return;
                }
                
                gameState.railroads[railroad].treasury -= cost;
                hex.locomotives.push(railroad);
                gameState.railroads[railroad].locomotives.push({ row: hex.row, col: hex.col });
                
                // Update dividends and share value if city
                if (hex.isMajorCity) {
                    gameState.railroads[railroad].dividends += 2;
                    // Major cities increase share value
                    gameState.railroads[railroad].shareValue = Math.min(gameState.railroads[railroad].shareValue + 2, 50);
                    logAction(`${player.name} built ${railroad} track at ${hex.cityName} (Major City) - Cost: ‚Çß${cost}, +2 Div Level, +‚Çß2 Share Value`);
                } else if (hex.isCity) {
                    gameState.railroads[railroad].dividends += 1;
                    logAction(`${player.name} built ${railroad} track at ${hex.cityName} (City) - Cost: ‚Çß${cost}, +1 Div Level`);
                } else {
                    const terrain = hex.terrain === 'difficult' ? 'difficult terrain' : 'easy terrain';
                    logAction(`${player.name} built ${railroad} track on ${terrain} - Cost: ‚Çß${cost}`);
                }
                
                // Check for 5 major cities connection bonus
                const majorCitiesConnected = gameState.railroads[railroad].locomotives.filter(loco => {
                    const h = gameState.hexMap.find(hex => hex.row === loco.row && hex.col === loco.col);
                    return h && h.isMajorCity;
                }).length;
                
                if (majorCitiesConnected === 5) {
                    // Special dividend for connecting 5 major cities
                    const bonusAmounts = { purple: 12, orange: 14, blue: 14, yellow: 12, red: 10 };
                    const bonus = bonusAmounts[railroad];
                    
                    gameState.railroads[railroad].shares.forEach(playerId => {
                        const p = gameState.players.find(player => player.id === playerId);
                        if (p) p.money += bonus;
                    });
                    
                    const unpurchasedBonus = bonus * (5 - gameState.railroads[railroad].shares.length);
                    gameState.railroads[railroad].treasury += unpurchasedBonus;
                    
                    logAction(`${railroad} connected 5 Major Cities! Special dividend: ‚Çß${bonus}/share`);
                }
            } else {
                logAction(`${railroad} cannot afford to build (needs ‚Çß${cost}, has ‚Çß${gameState.railroads[railroad].treasury})`);
            }
        }
        
        function claimPriority() {
            const message = {
                type: 'claimPriority',
                playerId: gameState.myPlayerId
            };
            
            if (isHost) {
                processClaimPriority(gameState.myPlayerId);
                broadcastGameState();
            } else {
                connections[0].send(message);
            }
        }
        
        function processClaimPriority(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            gameState.priorityDealHolder = playerId;
            logAction(`${player.name} claimed the Priority Deal token`);
        }
        
        function nextRound() {
            const message = {
                type: 'nextRound'
            };
            
            if (isHost) {
                processNextRound();
                broadcastGameState();
            } else {
                connections[0].send(message);
            }
        }
        
        function processNextRound() {
            // Round progression follows the pattern on the board
            const roundSequence = [
                'Stock 1', 'Build 1', 'Stock 2', 'Build 2', 'Stock 3', 'Build 3',
                'Stock 4', 'Build 4', 'Stock 5', 'Build 5', 'Final Build'
            ];
            
            let currentIndex = -1;
            const currentRoundName = `${gameState.round === 'stock' ? 'Stock' : 'Build'} ${gameState.roundNumber}`;
            
            for (let i = 0; i < roundSequence.length; i++) {
                if (roundSequence[i].includes(currentRoundName)) {
                    currentIndex = i;
                    break;
                }
            }
            
            if (currentIndex >= 0 && currentIndex < roundSequence.length - 1) {
                const nextRound = roundSequence[currentIndex + 1];
                
                if (nextRound.includes('Stock')) {
                    gameState.round = 'stock';
                    gameState.roundNumber = parseInt(nextRound.split(' ')[1]);
                } else if (nextRound === 'Final Build') {
                    gameState.round = 'build';
                    gameState.roundNumber = 6; // Final build
                } else {
                    gameState.round = 'build';
                    gameState.roundNumber = parseInt(nextRound.split(' ')[1]);
                }
                
                logAction(`Advanced to ${nextRound}`);
            } else {
                logAction('Game has ended!');
                calculateFinalScores();
            }
        }
        
        function calculateFinalScores() {
            let scoreText = 'FINAL SCORES:\n';
            gameState.players.forEach(player => {
                let totalValue = player.money;
                
                player.shares.forEach(share => {
                    totalValue += gameState.railroads[share.railroad].shareValue;
                });
                
                scoreText += `${player.name}: ‚Çß${totalValue}\n`;
            });
            
            logAction(scoreText);
            alert(scoreText);
        }
        
        function payAllDividends() {
            const colors = ['purple', 'orange', 'blue', 'yellow', 'red'];
            colors.forEach(railroad => {
                if (gameState.railroads[railroad].shares.length > 0) {
                    processPayDividends(railroad);
                }
            });
            
            if (isHost) {
                broadcastGameState();
            } else {
                connections[0].send({ type: 'payDividends' });
            }
        }
        
        function processPayDividends(railroad) {
            const dividendLevel = Math.min(gameState.railroads[railroad].dividends, gameState.dividendTrack.length - 1);
            const dividendRate = gameState.dividendTrack[dividendLevel][railroad];
            
            let totalPaid = 0;
            gameState.railroads[railroad].shares.forEach(playerId => {
                const player = gameState.players.find(p => p.id === playerId);
                if (player) {
                    player.money += dividendRate;
                    totalPaid += dividendRate;
                }
            });
            
            // Pay treasury for unpurchased shares
            const unpurchasedShares = 5 - gameState.railroads[railroad].shares.length;
            const treasuryDividend = dividendRate * unpurchasedShares;
            gameState.railroads[railroad].treasury += treasuryDividend;
            
            if (dividendRate > 0) {
                logAction(`${railroad} paid ‚Çß${dividendRate} per share (Level ${dividendLevel}). Treasury: +‚Çß${treasuryDividend}`);
            }
        }
        
        function resetGame() {
            if (confirm('Reset the entire game?')) {
                location.reload();
            }
        }
        
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background gradient to simulate ocean
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#4A90E2');
            gradient.addColorStop(1, '#2C5F8D');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            ctx.translate(camera.x, camera.y);
            ctx.scale(camera.zoom, camera.zoom);
            
            const hexSize = 30;
            
            // Draw hexagons
            gameState.hexMap.forEach(hex => {
                ctx.save();
                ctx.translate(hex.x + hexSize, hex.y + hexSize);
                
                // Draw hex shadow
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                // Draw hex
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = Math.PI / 3 * i;
                    const x = hexSize * Math.cos(angle);
                    const y = hexSize * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                
                // Fill based on terrain
                if (hex.isMajorCity) {
                    // Major cities - gold with gradient
                    const cityGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, hexSize);
                    cityGrad.addColorStop(0, '#FFE066');
                    cityGrad.addColorStop(1, '#F4B942');
                    ctx.fillStyle = cityGrad;
                } else if (hex.isCity) {
                    // Regular cities - light blue
                    ctx.fillStyle = '#A8DADC';
                } else if (hex.terrain === 'difficult') {
                    // Mountains - brown gradient
                    const mountGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, hexSize);
                    mountGrad.addColorStop(0, '#8D6E63');
                    mountGrad.addColorStop(1, '#6D4C41');
                    ctx.fillStyle = mountGrad;
                } else {
                    // Easy terrain - green gradient
                    const greenGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, hexSize);
                    greenGrad.addColorStop(0, '#81C784');
                    greenGrad.addColorStop(1, '#66BB6A');
                    ctx.fillStyle = greenGrad;
                }
                ctx.fill();
                
                // Draw border
                ctx.strokeStyle = '#2C3E50';
                ctx.lineWidth = 1.5;
                ctx.stroke();
                
                ctx.shadowColor = 'transparent';
                
                // Draw city icon for major cities
                if (hex.isMajorCity) {
                    ctx.fillStyle = '#2C3E50';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('üèõÔ∏è', 0, -5);
                } else if (hex.isCity) {
                    ctx.fillStyle = '#2C3E50';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('üèòÔ∏è', 0, -5);
                }
                
                // Draw city name
                if (hex.cityName) {
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 9px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.strokeText(hex.cityName, 0, 10);
                    ctx.fillText(hex.cityName, 0, 10);
                }
                
                // Draw locomotives
                if (hex.locomotives.length > 0) {
                    hex.locomotives.forEach((railroad, idx) => {
                        const colors = {
                            purple: '#8B008B',
                            orange: '#FF8C00',
                            blue: '#4169E1',
                            yellow: '#FFD700',
                            red: '#DC143C'
                        };
                        
                        const locX = (idx - (hex.locomotives.length - 1) / 2) * 12;
                        
                        // Draw locomotive token
                        ctx.beginPath();
                        ctx.arc(locX, -8, 6, 0, Math.PI * 2);
                        ctx.fillStyle = colors[railroad];
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // Draw small train icon
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 8px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('üöÇ', locX, -8);
                    });
                }
                
                // Draw terrain cost indicator
                if (!hex.isCity) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.font = '8px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`‚Çß${hex.terrain === 'difficult' ? '8' : '4'}`, 0, 22);
                }
                
                ctx.restore();
            });
            
            // Draw connections between hexes with locomotives
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            
            const railroadColors = ['purple', 'orange', 'blue', 'yellow', 'red'];
            railroadColors.forEach(railroad => {
                const locos = gameState.railroads[railroad].locomotives;
                if (locos.length > 1) {
                    ctx.beginPath();
                    locos.forEach((loco, idx) => {
                        const hex = gameState.hexMap.find(h => h.row === loco.row && h.col === loco.col);
                        if (hex) {
                            if (idx === 0) {
                                ctx.moveTo(hex.x + hexSize, hex.y + hexSize);
                            } else {
                                ctx.lineTo(hex.x + hexSize, hex.y + hexSize);
                            }
                        }
                    });
                    ctx.strokeStyle = getColorHex(railroad);
                    ctx.stroke();
                }
            });
            
            ctx.setLineDash([]);
            ctx.restore();
        }
        
        function updateUI() {
            // Update round info with proper formatting
            let roundDisplay = gameState.round === 'stock' ? 'Stock' : 'Build';
            if (gameState.round === 'build' && gameState.roundNumber === 6) {
                roundDisplay = 'Final Build';
            } else {
                roundDisplay += ` ${gameState.roundNumber}`;
            }
            document.getElementById('roundInfo').textContent = `Round: ${roundDisplay}`;
            
            // Update priority deal holder
            if (gameState.priorityDealHolder) {
                const holder = gameState.players.find(p => p.id === gameState.priorityDealHolder);
                document.getElementById('priorityInfo').textContent = 
                    `Priority Deal: ${holder ? holder.name : 'None'}`;
            } else {
                document.getElementById('priorityInfo').textContent = 'Priority Deal: None';
            }
            
            // Update player list with money and shares
            const playersList = document.getElementById('players');
            playersList.innerHTML = '';
            gameState.players.forEach((player) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                if (player.id === gameState.priorityDealHolder) {
                    div.classList.add('current-player');
                }
                
                const sharesSummary = {};
                player.shares.forEach(share => {
                    sharesSummary[share.railroad] = (sharesSummary[share.railroad] || 0) + 1;
                });
                
                const sharesText = Object.entries(sharesSummary)
                    .map(([railroad, count]) => `${railroad[0].toUpperCase()}:${count}`)
                    .join(' ');
                
                div.innerHTML = `
                    <div>${player.name}</div>
                    <div>‚Çß${player.money} ${sharesText ? `[${sharesText}]` : ''}</div>
                `;
                playersList.appendChild(div);
            });
            
            // Update action log
            const actionsDiv = document.getElementById('actions');
            actionsDiv.innerHTML = '';
            gameState.actionLog.slice(-10).reverse().forEach(action => {
                const div = document.createElement('div');
                div.style.padding = '5px';
                div.style.borderBottom = '1px solid rgba(255,255,255,0.2)';
                div.innerHTML = `<small>${action.time}</small><br>${action.message}`;
                actionsDiv.appendChild(div);
            });
            
            // Update share info with treasury and dividend info
            const shareInfo = document.getElementById('shareInfo');
            let shareText = '<strong>Railroads:</strong><br>';
            for (const [color, railroad] of Object.entries(gameState.railroads)) {
                const dividendLevel = Math.min(railroad.dividends, gameState.dividendTrack.length - 1);
                const currentDividend = gameState.dividendTrack[dividendLevel][color];
                
                shareText += `<div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                    <strong style="color: ${getColorHex(color)}">${color.toUpperCase()}</strong><br>
                    Share: ‚Çß${railroad.shareValue} | Treasury: ‚Çß${railroad.treasury}<br>
                    Shares: ${railroad.shares.length}/5 | Div Lvl: ${railroad.dividends} (‚Çß${currentDividend}/share)
                </div>`;
            }
            shareInfo.innerHTML = shareText;
            
            // Update railroad buttons to show current values
            const colors = ['purple', 'orange', 'blue', 'yellow', 'red'];
            colors.forEach(color => {
                const btn = document.querySelector(`.railroad-${color}`);
                if (btn) {
                    btn.innerHTML = `${color[0].toUpperCase()}<br><small>‚Çß${gameState.railroads[color].shareValue || 20}</small>`;
                }
            });
            
            render();
        }
        
        function getColorHex(color) {
            const colors = {
                purple: '#8B008B',
                orange: '#FF8C00',
                blue: '#4169E1',
                yellow: '#FFD700',
                red: '#DC143C'
            };
            return colors[color];
        }
        
        // Start rendering
        setInterval(render, 1000/30);
    </script>
</body>
</html>
