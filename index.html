<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iberian Gauge P2P</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.1/peerjs.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #8B7766;
            overflow: hidden;
        }
        
        #lobby {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .lobby-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }
        
        .lobby-title {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        #game {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #gameBoard {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 150px 1fr 200px;
            grid-template-rows: 120px 1fr 80px;
            gap: 0;
        }
        
        /* Initiative Track (Left) */
        #initiativeTrack {
            grid-column: 1;
            grid-row: 2;
            background: #f5f5dc;
            border: 3px solid #654321;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .railroad-track {
            background: white;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 5px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .railroad-header {
            font-weight: bold;
            text-align: center;
            padding: 5px;
            border-radius: 3px;
            color: white;
            margin-bottom: 5px;
        }
        
        .share-spaces {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
        }
        
        .share-space {
            background: #f0f0f0;
            border: 1px solid #999;
            border-radius: 3px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .share-space:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }
        
        .share-space.owned {
            font-weight: bold;
        }
        
        /* Dividend Track (Top) */
        #dividendTrack {
            grid-column: 2;
            grid-row: 1;
            background: #f5f5dc;
            border: 3px solid #654321;
            display: flex;
            align-items: center;
            padding: 10px;
        }
        
        .dividend-spaces {
            display: flex;
            gap: 2px;
            flex: 1;
            height: 100%;
        }
        
        .dividend-space {
            flex: 1;
            background: white;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            padding: 2px;
        }
        
        .dividend-values {
            display: flex;
            flex-direction: column;
            gap: 1px;
            width: 100%;
            font-size: 9px;
            text-align: center;
        }
        
        .dividend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            margin-top: 2px;
        }
        
        /* Map Area */
        #mapArea {
            grid-column: 2;
            grid-row: 2;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #4A90E2, #2C5F8D);
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        #gameCanvas:active {
            cursor: grabbing;
        }
        
        /* Share Value Track (Bottom) */
        #shareValueTrack {
            grid-column: 2;
            grid-row: 3;
            background: #f5f5dc;
            border: 3px solid #654321;
            display: flex;
            align-items: center;
            padding: 10px;
        }
        
        .value-spaces {
            display: flex;
            gap: 2px;
            flex: 1;
            height: 100%;
        }
        
        .value-space {
            flex: 1;
            background: white;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            border-radius: 3px;
        }
        
        .share-marker {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            position: absolute;
            transition: all 0.3s;
        }
        
        /* Control Panel (Right) */
        #controlPanel {
            grid-column: 3;
            grid-row: 1 / 4;
            background: #f5f5dc;
            border: 3px solid #654321;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        
        .control-section {
            background: white;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 10px;
        }
        
        .control-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        
        .player-item {
            padding: 5px;
            margin: 3px 0;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .action-item {
            padding: 3px;
            margin: 2px 0;
            font-size: 10px;
            border-left: 3px solid #666;
            padding-left: 5px;
        }
        
        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 3px 0;
            width: 100%;
        }
        
        .control-btn:hover {
            background: #45a049;
        }
        
        .railroad-purple { background: #8B008B; }
        .railroad-orange { background: #FF8C00; }
        .railroad-blue { background: #4169E1; }
        .railroad-yellow { background: #FFD700; color: black; }
        .railroad-red { background: #DC143C; }
        
        /* Top left corner info */
        #gameInfo {
            grid-column: 1;
            grid-row: 1;
            background: #f5f5dc;
            border: 3px solid #654321;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        #roundDisplay {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        #priorityDisplay {
            font-size: 12px;
        }
        
        /* Treasury display (Right top) */
        #treasuryArea {
            grid-column: 3;
            grid-row: 1;
            background: #f5f5dc;
            border: 3px solid #654321;
            padding: 5px;
            font-size: 11px;
        }
        
        .treasury-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 5px;
            margin: 2px 0;
            background: white;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="lobby">
        <div class="lobby-card">
            <h1 class="lobby-title">Iberian Gauge</h1>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="playerName" placeholder="Enter your name" value="Player">
            </div>
            <div class="input-group">
                <label>Room ID (leave empty to create new room)</label>
                <input type="text" id="roomId" placeholder="Enter room ID to join">
            </div>
            <button class="btn" id="startBtn">Start / Join Game</button>
            <div id="connectionStatus" style="margin-top: 20px; text-align: center; color: #666;"></div>
        </div>
    </div>
    
    <div id="game">
        <div id="gameBoard">
            <!-- Top Left: Round Info -->
            <div id="gameInfo">
                <div id="roundDisplay">Stock 1</div>
                <div id="priorityDisplay">Priority: None</div>
                <div id="roomDisplay" style="font-size: 10px; margin-top: 5px; color: #666;"></div>
            </div>
            
            <!-- Left: Initiative Track -->
            <div id="initiativeTrack">
                <div class="railroad-track">
                    <div class="railroad-header railroad-purple">PURPLE</div>
                    <div class="share-spaces" id="purple-shares"></div>
                </div>
                <div class="railroad-track">
                    <div class="railroad-header railroad-orange">ORANGE</div>
                    <div class="share-spaces" id="orange-shares"></div>
                </div>
                <div class="railroad-track">
                    <div class="railroad-header railroad-blue">BLUE</div>
                    <div class="share-spaces" id="blue-shares"></div>
                </div>
                <div class="railroad-track">
                    <div class="railroad-header railroad-yellow">YELLOW</div>
                    <div class="share-spaces" id="yellow-shares"></div>
                </div>
                <div class="railroad-track">
                    <div class="railroad-header railroad-red">RED</div>
                    <div class="share-spaces" id="red-shares"></div>
                </div>
            </div>
            
            <!-- Top: Dividend Track -->
            <div id="dividendTrack">
                <div class="dividend-spaces" id="dividend-spaces"></div>
            </div>
            
            <!-- Center: Map -->
            <div id="mapArea">
                <canvas id="gameCanvas"></canvas>
            </div>
            
            <!-- Bottom: Share Value Track -->
            <div id="shareValueTrack">
                <div class="value-spaces" id="value-spaces"></div>
            </div>
            
            <!-- Right: Control Panel -->
            <div id="controlPanel">
                <div class="control-section" id="roomInfoSection" style="display: none;">
                    <div class="control-title">Room Info</div>
                    <div style="font-size: 11px; padding: 5px;">
                        <strong>Room ID:</strong><br>
                        <code id="gameRoomId" style="background: #f0f0f0; padding: 3px; border-radius: 3px; font-size: 10px;"></code>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-title">Players</div>
                    <div id="playersList"></div>
                </div>
                
                <div class="control-section">
                    <div class="control-title">Treasury</div>
                    <div id="treasuryList"></div>
                </div>
                
                <div class="control-section">
                    <div class="control-title">Controls</div>
                    <button class="control-btn" id="nextRoundBtn">Next Round</button>
                    <button class="control-btn" id="payDividendsBtn">Pay Dividends</button>
                    <button class="control-btn" id="claimPriorityBtn">Claim Priority</button>
                    <button class="control-btn" id="resetBtn" style="background: #f44336;">Reset Game</button>
                </div>
                
                <div class="control-section">
                    <div class="control-title">Actions</div>
                    <div id="actionLog" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            players: [],
            round: 'stock',
            roundNumber: 1,
            railroads: {
                purple: { shares: [], treasury: 0, shareValue: 0, dividends: 0, locomotives: [] },
                orange: { shares: [], treasury: 0, shareValue: 0, dividends: 0, locomotives: [] },
                blue: { shares: [], treasury: 0, shareValue: 0, dividends: 0, locomotives: [] },
                yellow: { shares: [], treasury: 0, shareValue: 0, dividends: 0, locomotives: [] },
                red: { shares: [], treasury: 0, shareValue: 0, dividends: 0, locomotives: [] }
            },
            hexMap: [],
            myPlayerId: null,
            actionLog: [],
            priorityDealHolder: null,
            dividendTrack: [
                { purple: 0, orange: 0, blue: 0, yellow: 0, red: 0 },
                { purple: 0, orange: 0, blue: 0, yellow: 0, red: 0 },
                { purple: 0, orange: 2, blue: 2, yellow: 0, red: 0 },
                { purple: 2, orange: 2, blue: 2, yellow: 2, red: 0 },
                { purple: 2, orange: 4, blue: 4, yellow: 2, red: 2 },
                { purple: 4, orange: 4, blue: 4, yellow: 4, red: 2 },
                { purple: 4, orange: 6, blue: 6, yellow: 4, red: 4 },
                { purple: 6, orange: 6, blue: 6, yellow: 6, red: 4 },
                { purple: 6, orange: 8, blue: 8, yellow: 6, red: 6 },
                { purple: 8, orange: 8, blue: 8, yellow: 8, red: 6 },
                { purple: 8, orange: 10, blue: 10, yellow: 8, red: 8 },
                { purple: 10, orange: 10, blue: 10, yellow: 10, red: 8 },
                { purple: 10, orange: 12, blue: 12, yellow: 10, red: 10 },
                { purple: 12, orange: 12, blue: 12, yellow: 12, red: 10 },
                { purple: 12, orange: 14, blue: 14, yellow: 12, red: 12 },
                { purple: 14, orange: 14, blue: 14, yellow: 14, red: 12 },
                { purple: 14, orange: 16, blue: 16, yellow: 14, red: 14 },
                { purple: 16, orange: 16, blue: 16, yellow: 16, red: 14 },
                { purple: 16, orange: 18, blue: 18, yellow: 16, red: 16 },
                { purple: 18, orange: 18, blue: 18, yellow: 18, red: 16 }
            ]
        };
        
        // P2P Connection
        let peer = null;
        let connections = [];
        let isHost = false;
        
        // Canvas Setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let camera = { x: 0, y: 0, zoom: 0.8 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        
        // Initialize
        document.getElementById('startBtn').addEventListener('click', startGame);
        
        function startGame() {
            const playerName = document.getElementById('playerName').value || 'Player';
            const roomId = document.getElementById('roomId').value;
            
            if (roomId) {
                joinRoom(roomId, playerName);
            } else {
                createRoom(playerName);
            }
        }
        
        function createRoom(playerName) {
            isHost = true;
            const peerId = 'iberian-' + Math.random().toString(36).substr(2, 9);
            
            peer = new Peer(peerId);
            
            peer.on('open', (id) => {
                document.getElementById('connectionStatus').innerHTML = 
                    `<strong style="color: green;">✓ Room Created!</strong><br>
                    <div style="margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 10px;">
                        <strong>Room ID:</strong><br>
                        <code id="roomIdDisplay" style="font-size: 1.2em; user-select: all; background: white; padding: 8px; border-radius: 5px; display: inline-block; margin: 5px 0;">${id}</code>
                        <button onclick="copyRoomId()" style="margin-left: 10px; padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Copy</button><br>
                        <small>Share this ID with other players</small>
                    </div>
                    <div id="connectedPlayers" style="margin: 10px 0;">
                        <strong>Connected Players:</strong><br>
                        • ${playerName} (Host)
                    </div>
                    <button class="btn" onclick="startGameNow()" style="background: #4CAF50; margin-top: 15px;">Start Game</button>
                    <small style="display: block; margin-top: 10px; color: #666;">You can start with just yourself or wait for others to join</small>`;
                
                gameState.myPlayerId = id;
                gameState.players.push({
                    id: id,
                    name: playerName,
                    money: 40,
                    shares: [],
                    connected: true
                });
                
                // Store room ID globally for display in game
                window.roomId = id;
            });
            
            peer.on('connection', (conn) => {
                connections.push(conn);
                setupConnection(conn);
            });
        }
        
        function copyRoomId() {
            const roomIdElement = document.getElementById('roomIdDisplay');
            if (roomIdElement) {
                navigator.clipboard.writeText(roomIdElement.textContent).then(() => {
                    const originalText = event.target.textContent;
                    event.target.textContent = 'Copied!';
                    event.target.style.background = '#45a049';
                    setTimeout(() => {
                        event.target.textContent = originalText;
                        event.target.style.background = '#4CAF50';
                    }, 2000);
                }).catch(() => {
                    // Fallback for older browsers
                    const range = document.createRange();
                    range.selectNode(roomIdElement);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    document.execCommand('copy');
                    window.getSelection().removeAllRanges();
                });
            }
        }
        
        function startGameNow() {
            // Notify all connected players to start
            if (isHost) {
                connections.forEach(conn => {
                    if (conn.open) {
                        conn.send({ type: 'startGame' });
                    }
                });
            }
            
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            initGame();
        }
        
        function joinRoom(hostId, playerName) {
            const peerId = 'iberian-' + Math.random().toString(36).substr(2, 9);
            peer = new Peer(peerId);
            
            peer.on('open', (id) => {
                gameState.myPlayerId = id;
                const conn = peer.connect(hostId);
                
                conn.on('open', () => {
                    connections.push(conn);
                    conn.send({
                        type: 'join',
                        playerId: id,
                        playerName: playerName
                    });
                    
                    document.getElementById('connectionStatus').innerHTML = 
                        `<strong style="color: green;">✓ Connected to Room!</strong><br>
                        <div style="margin: 15px 0;">
                            Waiting for host to start the game...
                        </div>`;
                });
                
                conn.on('error', (err) => {
                    document.getElementById('connectionStatus').innerHTML = 
                        `<strong style="color: red;">✗ Connection Failed</strong><br>
                        <small>Check the Room ID and try again</small>`;
                });
                
                setupConnection(conn);
            });
        }
        
        function setupConnection(conn) {
            conn.on('data', (data) => {
                handleMessage(data, conn);
            });
            
            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
            });
        }
        
        function handleMessage(data, conn) {
            switch(data.type) {
                case 'join':
                    if (isHost) {
                        gameState.players.push({
                            id: data.playerId,
                            name: data.playerName,
                            money: 40,
                            shares: [],
                            connected: true
                        });
                        
                        // Update connected players display if still in lobby
                        const connectedDiv = document.getElementById('connectedPlayers');
                        if (connectedDiv) {
                            let playerList = '<strong>Connected Players:</strong><br>';
                            gameState.players.forEach(p => {
                                playerList += `• ${p.name}${p.id === gameState.myPlayerId ? ' (Host)' : ''}<br>`;
                            });
                            connectedDiv.innerHTML = playerList;
                        }
                        
                        // If game already started, notify new player
                        if (document.getElementById('game').style.display === 'block') {
                            conn.send({ type: 'startGame' });
                            broadcastGameState();
                        }
                        
                        logAction(`${data.playerName} joined`);
                    }
                    break;
                case 'startGame':
                    document.getElementById('lobby').style.display = 'none';
                    document.getElementById('game').style.display = 'block';
                    initGame();
                    break;
                case 'gameState':
                    gameState.players = data.players;
                    gameState.round = data.round;
                    gameState.roundNumber = data.roundNumber;
                    gameState.railroads = data.railroads;
                    gameState.actionLog = data.actionLog || [];
                    gameState.priorityDealHolder = data.priorityDealHolder;
                    if (data.hexMap) {
                        gameState.hexMap = data.hexMap;
                    }
                    updateUI();
                    break;
                case 'buyShare':
                    if (isHost) {
                        processBuyShare(data.playerId, data.railroad, data.shareValue);
                        broadcastGameState();
                    }
                    break;
                case 'buildTrack':
                    if (isHost) {
                        processBuildTrack(data.playerId, data.railroad, data.hex);
                        broadcastGameState();
                    }
                    break;
                case 'claimPriority':
                    if (isHost) {
                        processClaimPriority(data.playerId);
                        broadcastGameState();
                    }
                    break;
                case 'nextRound':
                    if (isHost) {
                        processNextRound();
                        broadcastGameState();
                    }
                    break;
                case 'payDividends':
                    if (isHost) {
                        payAllDividends();
                        broadcastGameState();
                    }
                    break;
            }
        }
        
        function broadcastGameState() {
            const message = {
                type: 'gameState',
                players: gameState.players,
                round: gameState.round,
                roundNumber: gameState.roundNumber,
                railroads: gameState.railroads,
                actionLog: gameState.actionLog,
                priorityDealHolder: gameState.priorityDealHolder,
                hexMap: gameState.hexMap
            };
            
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(message);
                }
            });
            updateUI();
        }
        
        function logAction(message) {
            const timestamp = new Date().toLocaleTimeString();
            gameState.actionLog.push({ time: timestamp, message });
            if (gameState.actionLog.length > 50) {
                gameState.actionLog.shift();
            }
            updateUI();
        }
        
        function initGame() {
            setupCanvas();
            generateHexMap();
            setupBoardUI();
            setupEventListeners();
            updateUI();
        }
        
        function setupCanvas() {
            const mapArea = document.getElementById('mapArea');
            canvas.width = mapArea.clientWidth;
            canvas.height = mapArea.clientHeight;
            
            window.addEventListener('resize', () => {
                canvas.width = mapArea.clientWidth;
                canvas.height = mapArea.clientHeight;
                render();
            });
        }
        
        function generateHexMap() {
            const hexSize = 30;
            
            const mapData = [
                // Portugal coast and cities
                [2, 2, 'easy', 'Porto'],
                [3, 2, 'easy'],
                [4, 2, 'easy', 'Lisboa'],
                [6, 2, 'easy', 'Faro'],
                
                // Northern Spain
                [1, 7, 'easy', 'Bilbao'],
                [1, 10, 'difficult'],
                [1, 13, 'easy', 'Pamplona'],
                
                // Central Spain
                [3, 5, 'difficult', 'Salamanca'],
                [3, 7, 'difficult', 'Valladolid'],
                [4, 7, 'easy', 'Madrid'],
                [5, 6, 'easy', 'Toledo'],
                
                // Eastern Spain
                [2, 12, 'difficult', 'Zaragoza'],
                [2, 15, 'easy', 'Barcelona'],
                [4, 14, 'easy', 'Valencia'],
                [5, 13, 'easy', 'Alicante'],
                
                // Southern Spain
                [6, 4, 'easy', 'Badajoz'],
                [7, 5, 'easy', 'Córdoba'],
                [8, 5, 'easy', 'Sevilla'],
                [8, 7, 'easy', 'Málaga'],
                [9, 4, 'easy', 'Cádiz'],
                [7, 8, 'easy', 'Granada'],
                [7, 10, 'easy', 'Murcia'],
                
                // Fill terrain
                [2, 3, 'difficult'],
                [2, 4, 'difficult'],
                [2, 5, 'difficult'],
                [2, 6, 'difficult'],
                [2, 8, 'difficult'],
                [2, 9, 'difficult'],
                [2, 10, 'difficult'],
                [2, 11, 'difficult'],
                [3, 3, 'difficult'],
                [3, 4, 'difficult'],
                [3, 6, 'difficult'],
                [3, 8, 'difficult'],
                [3, 9, 'difficult'],
                [3, 10, 'difficult'],
                [3, 11, 'difficult'],
                [3, 12, 'difficult'],
                [3, 13, 'difficult'],
                [3, 14, 'difficult'],
                [4, 3, 'difficult'],
                [4, 4, 'difficult'],
                [4, 5, 'difficult'],
                [4, 6, 'difficult'],
                [4, 8, 'difficult'],
                [4, 9, 'difficult'],
                [4, 10, 'difficult'],
                [4, 11, 'difficult'],
                [4, 12, 'difficult'],
                [4, 13, 'difficult'],
                [5, 3, 'easy'],
                [5, 4, 'easy'],
                [5, 5, 'easy'],
                [5, 7, 'easy'],
                [5, 8, 'easy'],
                [5, 9, 'easy'],
                [5, 10, 'easy'],
                [5, 11, 'easy'],
                [5, 12, 'easy'],
                [6, 3, 'easy'],
                [6, 5, 'easy'],
                [6, 6, 'easy'],
                [6, 7, 'easy'],
                [6, 8, 'easy'],
                [6, 9, 'easy'],
                [6, 10, 'easy'],
                [7, 3, 'easy'],
                [7, 4, 'easy'],
                [7, 6, 'easy'],
                [7, 7, 'easy'],
                [7, 9, 'easy'],
                [8, 6, 'easy']
            ];
            
            const majorCities = ['Madrid', 'Barcelona', 'Valencia', 'Sevilla', 'Lisboa', 
                                 'Porto', 'Bilbao', 'Zaragoza', 'Málaga'];
            
            gameState.hexMap = [];
            
            mapData.forEach(([row, col, terrain, cityName]) => {
                const x = col * hexSize * 1.5;
                const y = row * hexSize * Math.sqrt(3) + (col % 2 ? hexSize * Math.sqrt(3) / 2 : 0);
                
                gameState.hexMap.push({
                    x, y,
                    row, col,
                    terrain: terrain,
                    isCity: !!cityName,
                    isMajorCity: majorCities.includes(cityName),
                    cityName: cityName || null,
                    locomotives: []
                });
            });
        }
        
        function setupBoardUI() {
            // Setup dividend track spaces
            const dividendSpaces = document.getElementById('dividend-spaces');
            for (let i = 0; i < 21; i++) {
                const space = document.createElement('div');
                space.className = 'dividend-space';
                space.id = `dividend-${i}`;
                space.innerHTML = `<div class="dividend-values">
                    <div style="color:#8B008B">${gameState.dividendTrack[i].purple}</div>
                    <div style="color:#FF8C00">${gameState.dividendTrack[i].orange}</div>
                    <div style="color:#4169E1">${gameState.dividendTrack[i].blue}</div>
                    <div style="color:#FFD700; background: #333;">${gameState.dividendTrack[i].yellow}</div>
                    <div style="color:#DC143C">${gameState.dividendTrack[i].red}</div>
                </div>`;
                dividendSpaces.appendChild(space);
            }
            
            // Setup share value track
            const valueSpaces = document.getElementById('value-spaces');
            const values = [0, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50];
            values.forEach(val => {
                const space = document.createElement('div');
                space.className = 'value-space';
                space.id = `value-${val}`;
                space.textContent = val === 0 ? '-' : `₧${val}`;
                valueSpaces.appendChild(space);
            });
            
            // Setup share spaces for each railroad
            const colors = ['purple', 'orange', 'blue', 'yellow', 'red'];
            colors.forEach(color => {
                const container = document.getElementById(`${color}-shares`);
                for (let i = 0; i < 5; i++) {
                    const space = document.createElement('div');
                    space.className = 'share-space';
                    space.id = `${color}-share-${i}`;
                    space.onclick = () => buyShare(color, i);
                    space.textContent = 'Available';
                    container.appendChild(space);
                }
            });
        }
        
        function setupEventListeners() {
            // Canvas dragging
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStart.x = e.clientX - camera.x;
                dragStart.y = e.clientY - camera.y;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    camera.x = e.clientX - dragStart.x;
                    camera.y = e.clientY - dragStart.y;
                    render();
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomSpeed = 0.1;
                const oldZoom = camera.zoom;
                if (e.deltaY < 0) {
                    camera.zoom = Math.min(2, camera.zoom + zoomSpeed);
                } else {
                    camera.zoom = Math.max(0.5, camera.zoom - zoomSpeed);
                }
                
                const zoomRatio = camera.zoom / oldZoom;
                camera.x = e.clientX - (e.clientX - camera.x) * zoomRatio;
                camera.y = e.clientY - (e.clientY - camera.y) * zoomRatio;
                
                render();
            });
            
            // Click on hex
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const hex = getHexAtPoint(e.clientX - rect.left, e.clientY - rect.top);
                if (hex) {
                    showHexMenu(hex, e.clientX, e.clientY);
                }
            });
            
            // Control buttons
            document.getElementById('claimPriorityBtn').onclick = claimPriority;
            document.getElementById('payDividendsBtn').onclick = () => {
                if (isHost) {
                    payAllDividends();
                    broadcastGameState();
                } else {
                    connections[0].send({ type: 'payDividends' });
                }
            };
            document.getElementById('resetBtn').onclick = () => {
                if (confirm('Reset the entire game?')) {
                    location.reload();
                }
            };
            document.getElementById('nextRoundBtn').onclick = nextRound;
        }
        
        function getHexAtPoint(x, y) {
            const hexSize = 30 * camera.zoom;
            x = (x - camera.x) / camera.zoom;
            y = (y - camera.y) / camera.zoom;
            
            for (const hex of gameState.hexMap) {
                const dx = x - hex.x - hexSize;
                const dy = y - hex.y - hexSize;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < hexSize) {
                    return hex;
                }
            }
            return null;
        }
        
        function showHexMenu(hex, x, y) {
            const existingMenu = document.getElementById('hexMenu');
            if (existingMenu) existingMenu.remove();
            
            const menu = document.createElement('div');
            menu.id = 'hexMenu';
            menu.style.position = 'absolute';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.background = 'white';
            menu.style.border = '2px solid #333';
            menu.style.borderRadius = '5px';
            menu.style.padding = '10px';
            menu.style.zIndex = '1000';
            
            menu.innerHTML = '<strong>Build track for:</strong><br>';
            
            const colors = ['purple', 'orange', 'blue', 'yellow', 'red'];
            let hasOptions = false;
            
            colors.forEach(color => {
                if (gameState.railroads[color].shares.length > 0) {
                    hasOptions = true;
                    const btn = document.createElement('button');
                    btn.className = `railroad-btn railroad-${color}`;
                    btn.style.width = '100%';
                    btn.style.margin = '2px 0';
                    btn.style.padding = '5px';
                    btn.style.border = 'none';
                    btn.style.borderRadius = '3px';
                    btn.style.color = 'white';
                    btn.style.cursor = 'pointer';
                    
                    const cost = hex.terrain === 'difficult' ? 8 : 4;
                    const treasury = gameState.railroads[color].treasury;
                    btn.innerHTML = `${color} (₧${treasury})`;
                    
                    if (treasury < cost) {
                        btn.style.opacity = '0.5';
                        btn.disabled = true;
                    }
                    
                    btn.onclick = () => {
                        buildTrack(color, hex);
                        menu.remove();
                    };
                    menu.appendChild(btn);
                }
            });
            
            if (!hasOptions) {
                menu.innerHTML += '<small>No railroads started</small><br>';
            }
            
            const info = document.createElement('div');
            info.style.marginTop = '10px';
            info.style.fontSize = '11px';
            info.innerHTML = `<strong>Hex Info:</strong><br>`;
            if (hex.cityName) {
                info.innerHTML += `${hex.cityName}<br>`;
            }
            info.innerHTML += `Cost: ₧${hex.terrain === 'difficult' ? 8 : 4}<br>`;
            if (hex.isMajorCity) {
                info.innerHTML += `Major City (+2 Div, +₧2 Value)<br>`;
            } else if (hex.isCity) {
                info.innerHTML += `City (+1 Div)<br>`;
            }
            menu.appendChild(info);
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Cancel';
            closeBtn.style.marginTop = '10px';
            closeBtn.style.width = '100%';
            closeBtn.onclick = () => menu.remove();
            menu.appendChild(closeBtn);
            
            document.body.appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }
        
        function buyShare(railroad, shareIndex) {
            const share = gameState.railroads[railroad].shares[shareIndex];
            if (share) return; // Already owned
            
            const myPlayer = gameState.players.find(p => p.id === gameState.myPlayerId);
            if (!myPlayer) return;
            
            const isFirstShare = gameState.railroads[railroad].shares.length === 0;
            let shareValue = gameState.railroads[railroad].shareValue;
            
            if (isFirstShare) {
                const value = prompt(`Starting ${railroad} railroad. Choose share value (₧12-₧36):`, '20');
                if (!value) return;
                shareValue = Math.max(12, Math.min(36, parseInt(value) || 20));
                shareValue = Math.round(shareValue / 2) * 2;
            } else if (!shareValue || shareValue === 0) {
                alert('Railroad not started');
                return;
            }
            
            if (myPlayer.money >= shareValue) {
                const message = {
                    type: 'buyShare',
                    playerId: gameState.myPlayerId,
                    railroad: railroad,
                    shareValue: shareValue
                };
                
                if (isHost) {
                    processBuyShare(gameState.myPlayerId, railroad, shareValue);
                    broadcastGameState();
                } else {
                    connections[0].send(message);
                }
            } else {
                alert(`Insufficient funds. Need ₧${shareValue}, have ₧${myPlayer.money}`);
            }
        }
        
        function processBuyShare(playerId, railroad, shareValue) {
            const player = gameState.players.find(p => p.id === playerId);
            if (player && player.money >= shareValue && gameState.railroads[railroad].shares.length < 5) {
                player.money -= shareValue;
                player.shares.push({ railroad, value: shareValue });
                
                gameState.railroads[railroad].shares.push(playerId);
                gameState.railroads[railroad].treasury += shareValue;
                gameState.railroads[railroad].shareValue = shareValue;
                
                const isFirst = gameState.railroads[railroad].shares.length === 1;
                logAction(`${player.name} ${isFirst ? 'started' : 'bought'} ${railroad} at ₧${shareValue}`);
            }
        }
        
        function buildTrack(railroad, hex) {
            if (gameState.railroads[railroad].shares.length === 0) {
                alert(`${railroad} railroad not started`);
                return;
            }
            
            const cost = hex.terrain === 'difficult' ? 8 : 4;
            
            if (gameState.railroads[railroad].treasury >= cost) {
                const message = {
                    type: 'buildTrack',
                    playerId: gameState.myPlayerId,
                    railroad: railroad,
                    hex: { row: hex.row, col: hex.col }
                };
                
                if (isHost) {
                    processBuildTrack(gameState.myPlayerId, railroad, { row: hex.row, col: hex.col });
                    broadcastGameState();
                } else {
                    connections[0].send(message);
                }
            } else {
                alert(`${railroad} needs ₧${cost}, has ₧${gameState.railroads[railroad].treasury}`);
            }
        }
        
        function processBuildTrack(playerId, railroad, hexData) {
            const hex = gameState.hexMap.find(h => h.row === hexData.row && h.col === hexData.col);
            if (!hex) return;
            
            const cost = hex.terrain === 'difficult' ? 8 : 4;
            const player = gameState.players.find(p => p.id === playerId);
            
            const isFirst = gameState.railroads[railroad].locomotives.length === 0;
            if (isFirst && !hex.isMajorCity) {
                logAction(`${railroad} must start in a Major City!`);
                return;
            }
            
            if (hex.locomotives.includes(railroad)) {
                logAction(`${railroad} already has track here`);
                return;
            }
            
            if (hex.locomotives.length > 0 && !hex.isCity && !hex.isMajorCity) {
                logAction(`Only one railroad on non-city hexes`);
                return;
            }
            
            if (gameState.railroads[railroad].treasury >= cost) {
                gameState.railroads[railroad].treasury -= cost;
                hex.locomotives.push(railroad);
                gameState.railroads[railroad].locomotives.push({ row: hex.row, col: hex.col });
                
                if (hex.isMajorCity) {
                    gameState.railroads[railroad].dividends += 2;
                    gameState.railroads[railroad].shareValue = Math.min(gameState.railroads[railroad].shareValue + 2, 50);
                    logAction(`${player.name}: ${railroad} at ${hex.cityName} -₧${cost} +2Div +₧2Value`);
                } else if (hex.isCity) {
                    gameState.railroads[railroad].dividends += 1;
                    logAction(`${player.name}: ${railroad} at ${hex.cityName} -₧${cost} +1Div`);
                } else {
                    logAction(`${player.name}: ${railroad} on ${hex.terrain} -₧${cost}`);
                }
            }
        }
        
        function claimPriority() {
            const message = {
                type: 'claimPriority',
                playerId: gameState.myPlayerId
            };
            
            if (isHost) {
                processClaimPriority(gameState.myPlayerId);
                broadcastGameState();
            } else {
                connections[0].send(message);
            }
        }
        
        function processClaimPriority(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            gameState.priorityDealHolder = playerId;
            logAction(`${player.name} claimed Priority Deal`);
        }
        
        function nextRound() {
            const message = { type: 'nextRound' };
            
            if (isHost) {
                processNextRound();
                broadcastGameState();
            } else {
                connections[0].send(message);
            }
        }
        
        function processNextRound() {
            const sequence = [
                'Stock 1', 'Build 1', 'Stock 2', 'Build 2', 'Stock 3', 'Build 3',
                'Stock 4', 'Build 4', 'Stock 5', 'Build 5', 'Final Build'
            ];
            
            const current = gameState.round === 'build' && gameState.roundNumber === 6 
                ? 'Final Build' 
                : `${gameState.round === 'stock' ? 'Stock' : 'Build'} ${gameState.roundNumber}`;
            
            const currentIndex = sequence.indexOf(current);
            
            if (currentIndex < sequence.length - 1) {
                const next = sequence[currentIndex + 1];
                
                if (next === 'Final Build') {
                    gameState.round = 'build';
                    gameState.roundNumber = 6;
                } else {
                    const [type, num] = next.split(' ');
                    gameState.round = type.toLowerCase();
                    gameState.roundNumber = parseInt(num);
                }
                
                logAction(`Advanced to ${next}`);
            } else {
                calculateFinalScores();
            }
        }
        
        function payAllDividends() {
            ['purple', 'orange', 'blue', 'yellow', 'red'].forEach(railroad => {
                if (gameState.railroads[railroad].shares.length > 0) {
                    const dividendLevel = Math.min(gameState.railroads[railroad].dividends, 20);
                    const rate = gameState.dividendTrack[dividendLevel][railroad];
                    
                    gameState.railroads[railroad].shares.forEach(playerId => {
                        const player = gameState.players.find(p => p.id === playerId);
                        if (player) player.money += rate;
                    });
                    
                    const unpurchased = 5 - gameState.railroads[railroad].shares.length;
                    gameState.railroads[railroad].treasury += rate * unpurchased;
                    
                    if (rate > 0) {
                        logAction(`${railroad}: ₧${rate}/share (Lvl ${dividendLevel})`);
                    }
                }
            });
        }
        
        function calculateFinalScores() {
            let scores = [];
            gameState.players.forEach(player => {
                let total = player.money;
                player.shares.forEach(share => {
                    total += gameState.railroads[share.railroad].shareValue;
                });
                scores.push({ name: player.name, total });
            });
            
            scores.sort((a, b) => b.total - a.total);
            
            let result = '🏁 GAME OVER 🏁\n\n';
            scores.forEach((s, i) => {
                const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '';
                result += `${medal} ${s.name}: ₧${s.total}\n`;
            });
            
            logAction(result);
            alert(result);
        }
        
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            ctx.translate(camera.x, camera.y);
            ctx.scale(camera.zoom, camera.zoom);
            
            const hexSize = 30;
            
            // Draw hexagons
            gameState.hexMap.forEach(hex => {
                ctx.save();
                ctx.translate(hex.x + hexSize, hex.y + hexSize);
                
                // Draw hex
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = Math.PI / 3 * i;
                    const x = hexSize * Math.cos(angle);
                    const y = hexSize * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                
                // Fill based on terrain
                if (hex.isMajorCity) {
                    ctx.fillStyle = '#FFE066';
                } else if (hex.isCity) {
                    ctx.fillStyle = '#A8DADC';
                } else if (hex.terrain === 'difficult') {
                    ctx.fillStyle = '#8D6E63';
                } else {
                    ctx.fillStyle = '#81C784';
                }
                ctx.fill();
                ctx.strokeStyle = '#2C3E50';
                ctx.lineWidth = 1.5;
                ctx.stroke();
                
                // Draw city name
                if (hex.cityName) {
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 9px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(hex.cityName, 0, 0);
                }
                
                // Draw locomotives
                if (hex.locomotives.length > 0) {
                    hex.locomotives.forEach((railroad, idx) => {
                        const colors = {
                            purple: '#8B008B',
                            orange: '#FF8C00',
                            blue: '#4169E1',
                            yellow: '#FFD700',
                            red: '#DC143C'
                        };
                        
                        const locX = (idx - (hex.locomotives.length - 1) / 2) * 12;
                        
                        ctx.beginPath();
                        ctx.arc(locX, -10, 6, 0, Math.PI * 2);
                        ctx.fillStyle = colors[railroad];
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    });
                }
                
                ctx.restore();
            });
            
            ctx.restore();
        }
        
        function updateUI() {
            // Update round display
            let roundText = gameState.round === 'build' && gameState.roundNumber === 6 
                ? 'Final Build' 
                : `${gameState.round === 'stock' ? 'Stock' : 'Build'} ${gameState.roundNumber}`;
            document.getElementById('roundDisplay').textContent = roundText;
            
            // Update priority
            const holder = gameState.priorityDealHolder 
                ? gameState.players.find(p => p.id === gameState.priorityDealHolder) 
                : null;
            document.getElementById('priorityDisplay').textContent = 
                `Priority: ${holder ? holder.name : 'None'}`;
            
            // Update room ID display
            if (window.roomId && isHost) {
                document.getElementById('roomDisplay').innerHTML = `Room: ${window.roomId}`;
                document.getElementById('roomInfoSection').style.display = 'block';
                document.getElementById('gameRoomId').textContent = window.roomId;
            }
            // Update players
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                const shares = {};
                player.shares.forEach(s => {
                    shares[s.railroad] = (shares[s.railroad] || 0) + 1;
                });
                const shareText = Object.entries(shares)
                    .map(([r, n]) => `${r[0].toUpperCase()}:${n}`)
                    .join(' ');
                div.innerHTML = `<strong>${player.name}</strong><br>₧${player.money} ${shareText}`;
                playersList.appendChild(div);
            });
            
            // Update treasury
            const treasuryList = document.getElementById('treasuryList');
            treasuryList.innerHTML = '';
            ['purple', 'orange', 'blue', 'yellow', 'red'].forEach(color => {
                const div = document.createElement('div');
                div.className = 'treasury-row';
                const railroad = gameState.railroads[color];
                div.innerHTML = `<span style="color:${getColorHex(color)}">${color.toUpperCase()}</span>
                                <span>₧${railroad.treasury}</span>`;
                treasuryList.appendChild(div);
            });
            
            // Update share spaces
            ['purple', 'orange', 'blue', 'yellow', 'red'].forEach(color => {
                const railroad = gameState.railroads[color];
                for (let i = 0; i < 5; i++) {
                    const space = document.getElementById(`${color}-share-${i}`);
                    if (i < railroad.shares.length) {
                        const owner = gameState.players.find(p => p.id === railroad.shares[i]);
                        space.textContent = owner ? owner.name : 'Owned';
                        space.className = 'share-space owned';
                        space.style.background = getColorHex(color);
                        space.style.color = 'white';
                    } else {
                        space.textContent = railroad.shareValue > 0 ? `₧${railroad.shareValue}` : 'New';
                        space.className = 'share-space';
                        space.style.background = '#f0f0f0';
                        space.style.color = '#333';
                    }
                }
            });
            
            // Update dividend markers
            ['purple', 'orange', 'blue', 'yellow', 'red'].forEach(color => {
                const level = Math.min(gameState.railroads[color].dividends, 20);
                const oldMarker = document.getElementById(`${color}-dividend-marker`);
                if (oldMarker) oldMarker.remove();
                
                if (gameState.railroads[color].shares.length > 0) {
                    const marker = document.createElement('div');
                    marker.id = `${color}-dividend-marker`;
                    marker.className = 'dividend-marker';
                    marker.style.background = getColorHex(color);
                    document.getElementById(`dividend-${level}`).appendChild(marker);
                }
            });
            
            // Update share value markers
            ['purple', 'orange', 'blue', 'yellow', 'red'].forEach(color => {
                const oldMarker = document.getElementById(`${color}-value-marker`);
                if (oldMarker) oldMarker.remove();
                
                const value = gameState.railroads[color].shareValue;
                if (value > 0) {
                    const marker = document.createElement('div');
                    marker.id = `${color}-value-marker`;
                    marker.className = 'share-marker';
                    marker.style.background = getColorHex(color);
                    marker.textContent = color[0].toUpperCase();
                    const space = document.getElementById(`value-${value}`);
                    if (space) {
                        marker.style.position = 'relative';
                        marker.style.marginTop = '2px';
                        space.appendChild(marker);
                    }
                }
            });
            
            // Update action log
            const actionLog = document.getElementById('actionLog');
            actionLog.innerHTML = '';
            gameState.actionLog.slice(-10).reverse().forEach(action => {
                const div = document.createElement('div');
                div.className = 'action-item';
                div.innerHTML = `${action.time}: ${action.message}`;
                actionLog.appendChild(div);
            });
            
            render();
        }
        
        function getColorHex(color) {
            const colors = {
                purple: '#8B008B',
                orange: '#FF8C00',
                blue: '#4169E1',
                yellow: '#FFD700',
                red: '#DC143C'
            };
            return colors[color];
        }
        
        // Start rendering
        setInterval(render, 1000/30);
    </script>
</body>
</html>
